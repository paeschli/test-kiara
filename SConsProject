#-*- Python -*-

# SConsBuilder Project File
#
# This file will be executed after the initial build environment is created
# but before it is finalized.
#
# - Available variables for import -
#
# init_env - Initial build environment
#
# - Available environment variables -
#
#  init_env['BUILD_DIR'] - building directory
#  init_env['OBJ_DIR']   - building subdirectory for object files, etc.
#
# You should at least declare following init_env variables:
#
# INCLUDE_DIR      - Include directory
# SOURCE_DIRS      - All source directories
# LIB_DIR          - Destination directory for libraries
# BIN_DIR          - Destination directory for executables
# CONFIG_HEADER    - Used for autogenerated configuration header
#                    use None or ConfigHeader()
# PROJECT_PREFIX   - Used for auto-configuration
# SYSTEM_PREFIX    - Used for auto-configuration
# COMPILER_PREFIX  - Used for auto-configuration
# AUTOCONF_PREFIX  - Used for auto-configuration

import sys
import os
import os.path
import datetime
from builder.btools import *

Import('init_env')

AddCustomVariables(
    BoolVariable('disable_llvm', 'force building without LLVM', 0),
    ('llvm_cpppath',
     'Additional include paths to use (separated by \''+os.pathsep+'\')')
    )

BUILD_DIR = init_env['BUILD_DIR']

SOURCE_DIRS = Split("""
#src
""")

INCLUDE_DIR = BUILD_DIR + os.sep + 'include'
LIB_DIR = BUILD_DIR + os.sep + 'lib'
BIN_DIR = BUILD_DIR + os.sep + 'bin'

CONFIG_HEADER = ConfigHeader()

# define symbol prefixes

PROJECT_PREFIX = 'KIARA_'
SYSTEM_PREFIX = ''
COMPILER_PREFIX = 'COMPILER_'
AUTOCONF_PREFIX = 'KIARA_'

init_env.Replace(CXXFILESUFFIX='.cpp',
                 INCLUDE_DIR=INCLUDE_DIR,
                 SOURCE_DIRS=SOURCE_DIRS,
                 LIB_DIR=LIB_DIR,
                 BIN_DIR=BIN_DIR,
                 CONFIG_HEADER=CONFIG_HEADER,
                 PROJECT_PREFIX=PROJECT_PREFIX,
                 SYSTEM_PREFIX=SYSTEM_PREFIX,
                 COMPILER_PREFIX=COMPILER_PREFIX,
                 AUTOCONF_PREFIX=AUTOCONF_PREFIX,
                 CPPPATH=SOURCE_DIRS,
                 LIBPATH=[LIB_DIR])

# Setup configuration, conf is created by env.Configure()

def customizeConfiguration(conf):
    # in conf.env is the environment that can be changed
    isWin32 = conf.env['PLATFORM'] == 'win32'

    # On Windows append win32tools/include to CPPPATH
    #                   win32tools/lib to LIBPATH
    #                   win32tools/bin to PATH
    if isWin32:
        win32toolsDir = os.path.join(conf.env.Dir('#').abspath, 'win32tools')
        if os.path.exists(win32toolsDir):
            conf.env.Append(CPPPATH = [os.path.join(win32toolsDir, 'include')])
            conf.env.Append(LIBPATH = [os.path.join(win32toolsDir, 'lib')])
            conf.env.PrependENVPath('PATH', os.path.join(win32toolsDir, 'bin'))

    conf.env.Tool('textfile')

    # init lex tool
    conf.env.Tool('lex')
    # check lex tool

    # Get git revision
    import subprocess
    import types
    gitRevision = '<unknown>'
    conf.env.Replace(GIT_REVISION=gitRevision)
    try:
        osenv={}
        for k, v in os.environ.iteritems():
            if type(v) is not types.StringType:
                osenv[k] = str(v)
            else:
                osenv[k] = v

        p = subprocess.Popen(["git","rev-parse","--short=10","HEAD"],
                             env=osenv,
                             stdout=subprocess.PIPE)
        gitRevision = p.communicate()[0].strip()
        if p.returncode == 0:
            conf.env.Replace(GIT_REVISION=gitRevision)
        del osenv
    except OSError, e:
        print >>sys.stderr, "Git execution failed:", e

    print "* Building from Git Repository Revision: %s" % gitRevision

    pathToLex = conf.env.WhereIs(conf.env.get('LEX'))
    if pathToLex:
        print '* Use lexer tool from %s' % pathToLex
        conf.env.Replace(HAVE_LEX=1)
    else:
        print >>sys.stderr, 'Warning: Could not find lex/flex tool'
        conf.env.Replace(HAVE_LEX=0)

    if not conf.CheckCCompiler():
        print >>sys.stderr, 'Error: Could not run C/C++ compiler'
        Exit(1)

    if not bool(conf.env.get('disable_llvm')):
        if conf.CheckLLVM(write_config_h=False, use_clang_if_available=True,
                          min_version=Version(3, 3)):
            conf.env.Replace(HAVE_LLVM=True)
        else:
            conf.env.Replace(HAVE_LLVM=False)

        if conf.CheckClang(write_config_h=False):
            conf.env.Replace(HAVE_CLANG=True)
        else:
            conf.env.Replace(HAVE_CLANG=False)
    else:
        print "* Building with LLVM is disabled"
        conf.env.Replace(HAVE_LLVM=False)
        conf.env.Replace(HAVE_CLANG=False)

    if not conf.CheckBoostThread():
        print >>sys.stderr, 'Error: Could not find Boost Thread library'
        Exit(1)

    if not conf.CheckBoostFileSystem():
        print >>sys.stderr, 'Error: Could not find Boost Filesystem library'
        Exit(1)

    if not conf.CheckDFC(write_config_h=False):
        print >>sys.stderr, 'Error: Could not find DFC library'
        Exit(1)

    if not conf.CheckOpenSSL():
        print >>sys.stderr, 'Error: Could not find OpenSSL library'
        Exit(1)

    if not conf.CheckCurl():
        print >>sys.stderr, 'Error: Could not find Curl library'
        Exit(1)

    if not conf.CheckBoostSerialization():
        print >>sys.stderr, 'Error: Could not find Boost Serialization library'
        Exit(1)

    sizeof_longdouble = conf.CheckTypeSize('long double')
    conf.env.Replace(SIZEOF_LONGDOUBLE=sizeof_longdouble)

    if conf.CheckCHeader('ndds/ndds_c.h', include_quotes='<>'):
        conf.env.Replace(HAVE_NDDS_C=True)
    else:
        conf.env.Replace(HAVE_NDDS_C=False)

    if conf.CheckCXXHeader('ndds/ndds_cpp.h', include_quotes='<>'):
        conf.env.Replace(HAVE_NDDS_CPP=True)
    else:
        conf.env.Replace(HAVE_NDDS_CPP=False)

    # check boost headers
    headers = Split('''
    boost/bind.hpp
    boost/function.hpp
    boost/variant.hpp
    boost/algorithm/string/predicate.hpp
    boost/asio.hpp
    ''')
    for h in headers:
        if not conf.CheckCXXHeader(h):
            print >>sys.stderr, 'Error: Could not find boost header file',h
            Exit(1)

    if conf.CheckBoostUnitTestFramework():
        conf.env.Replace(HAVE_BOOST_UNIT_TEST_FRAMEWORK=1)
    else:
        conf.env.Replace(HAVE_BOOST_UNIT_TEST_FRAMEWORK=0)


RegisterConfigurationCustomizer(customizeConfiguration)

# Customize final environment

def finalizeEnvironment(env):
    # Evaluate building hierarchy
    Export('env')

    # setup install directories

    INSTALL_DIR = env['prefix']

    INSTALL_INCLUDE_DIR = os.path.join(INSTALL_DIR, 'include')
    INSTALL_LIB_DIR     = os.path.join(INSTALL_DIR, 'lib')
    INSTALL_BIN_DIR     = os.path.join(INSTALL_DIR, 'bin')

    INSTALL_DIRS = [INSTALL_INCLUDE_DIR,
                    INSTALL_LIB_DIR,
                    INSTALL_BIN_DIR]

    env.Replace(INSTALL_INCLUDE_DIR = INSTALL_INCLUDE_DIR,
                INSTALL_LIB_DIR = INSTALL_LIB_DIR,
                INSTALL_BIN_DIR = INSTALL_BIN_DIR,
                INSTALL_DIRS = INSTALL_DIRS)

    # process all source directories

    for srcDir in SOURCE_DIRS:
        buildDir = srcDir
        if buildDir.startswith('#'):
            buildDir = buildDir[1:]

        buildDir = os.path.join(env['OBJ_DIR'], buildDir)

        VariantDir(buildDir, srcDir, duplicate=0)
        SConscript(os.path.join(buildDir, 'SConscript'))

    # Alternate method to setup build directory :
    # SConscript('src' + os.sep + 'SConscript',
    #            build_dir=env['BUILD_DIR'],
    #            src_dir=env['SRC_DIR'],
    #            duplicate=0)

    # build documentation

    DOXYGEN_OUTPUT_DIR = '#doc/doxygen'
    DOXYGEN_CONFIG_FILE = '#doc/Doxyfile'

    env.Command(env.Dir(DOXYGEN_OUTPUT_DIR), DOXYGEN_CONFIG_FILE,
                "doxygen $SOURCES",
                ENV = {'DOXYGEN_OUTPUT_DIR' : env.Dir(DOXYGEN_OUTPUT_DIR).abspath,
                       'DOXYGEN_INPUT_DIR' : env.Dir('#src').abspath
                       })
    env.Alias('doc', env.Dir(DOXYGEN_OUTPUT_DIR))
    env.AlwaysBuild(env.Dir(DOXYGEN_OUTPUT_DIR))
    Help("""doc:            Generate doxygen documentation""")

    # default targets

    Default(env['BUILD_DIR'])
    #Default(env['INCLUDE_DIR'])

    # install targets

    env.Alias('install', INSTALL_DIR)

    # release and full-release target

    curdate = datetime.date.today().isoformat()

    MAJOR_VERSION = 2
    MINOR_VERSION = 0
    PATCH_VERSION = 0

    VERSION = "%i-%i-%i" % (MAJOR_VERSION, MINOR_VERSION, PATCH_VERSION)
    TARGET_ARCH_SUFFIX = env.get('TARGET_ARCH_SUFFIX', 'IA32')

    RELEASE_NAME = 'kiara-Release-Version-%s-%s-%s' % \
                   (VERSION, TARGET_ARCH_SUFFIX, curdate)

    FULL_RELEASE_NAME = 'kiara-Full-Release-Version-%s-%s-%s' % \
                        (VERSION, TARGET_ARCH_SUFFIX, curdate)

    release = env.CreateDist('#/'+RELEASE_NAME,
                             Split('bin lib bin-openrt lib-openrt'),
                             'RTSG',
                             excludeExts=['.cvsignore', '.sconsign'],
                             excludeDirs=['CVS','.svn','.sconf_temp'])
    env.Alias('release', release)

    full_release = env.CreateDist('#/'+FULL_RELEASE_NAME,
                                  Split('bin lib include include-openrt engines'),
                                  'rtsg',
                                  excludeExts=['.cvsignore', '.sconsign'],
                                  excludeDirs=['CVS','.svn','.sconf_temp'])
    env.Alias('full-release', full_release)

    # Don't bother computing the MD5 checksum of a file (to see whether the
    # contents of a file have changed) if the file's timestamp has not changed.
    # See: http://www.scons.org/doc/HTML/scons-user/c824.html#AEN944
    env.Decider('MD5-timestamp')

RegisterEnvironmentFinalizer(finalizeEnvironment)
